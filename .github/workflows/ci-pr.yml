name: CI (Pull Request)

on: [pull_request]

jobs:
  # This job checks which services have changed
  changed-files:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      app: ${{ steps.filter.outputs.app }}
      website: ${{ steps.filter.outputs.website }}
      integration: ${{ steps.filter.outputs.integration }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            api:
              - 'api/**'
            app:
              - 'app/**'
            website:
              - 'website/**'
            # The integration tests should also run if the test files themselves change
            integration:
              - 'api/**'
              - 'app/**'
              - 'tests/integration/**'

  unit-tests:
    runs-on: ubuntu-latest
    needs: changed-files
    strategy:
      matrix:
        service: [api, app, website]
        include:
          - service: api
            path: 'api'
            run_if: ${{ needs.changed-files.outputs.api == 'true' }}
          - service: app
            path: 'app'
            run_if: ${{ needs.changed-files.outputs.app == 'true' }}
          - service: website
            path: 'website'
            run_if: ${{ needs.changed-files.outputs.website == 'true' }}
    
    if: ${{ matrix.run_if }}
    
    steps:
      - uses: actions/checkout@v4
      - name: Run Unit Tests for ${{ matrix.service }}
        run: |
          cd ${{ matrix.path }}
          # (Your build/test commands: e.g., pip install, npm test)
          echo "Running unit tests for ${{ matrix.service }}..."

  integration-test:
    runs-on: ubuntu-latest
    needs: [changed-files, unit-tests]
    
    # Only run this job if api, app, or the tests themselves changed
    if: ${{ needs.changed-files.outputs.integration == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start Services
        run: |
          docker-compose -f.devcontainer/docker-compose.yml up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services..."
          sleep 30 # A more robust check would poll /health endpoints
      
      - name: Run Integration Tests
        run: |
          docker-compose -f.devcontainer/docker-compose.yml exec -T api \
            bash -c "pip install -r /workspace/tests/integration/requirements.txt && pytest /workspace/tests/integration"

      - name: Stop Services
        if: always()
        run: |
          docker-compose -f.devcontainer/docker-compose.yml down